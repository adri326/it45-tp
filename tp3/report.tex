\documentclass[12pt]{article}

\setlength{\parskip}{1em}

\usepackage[T1]{fontenc}
\usepackage[a4paper, margin=0.7in]{geometry}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{stmaryrd}
\usepackage{xcolor}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{float}
\usepackage{pdfpages}
\usepackage[french]{babel}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{charter}

\pgfplotsset{compat=1.18}

% \usepgfplotslibrary{external}
% \tikzexternalize

\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  urlcolor=blue,
  pdftitle={RS40: TP1}
}

\lstset{literate=
  {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
  {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
  {à}{{\`a}}1 {è}{{\`e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
  {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
  {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
  {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
  {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
  {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
  {ã}{{\~a}}1 {ẽ}{{\~e}}1 {ĩ}{{\~i}}1 {õ}{{\~o}}1 {ũ}{{\~u}}1
  {Ã}{{\~A}}1 {Ẽ}{{\~E}}1 {Ĩ}{{\~I}}1 {Õ}{{\~O}}1 {Ũ}{{\~U}}1
  {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
  {ű}{{\H{u}}}1 {Ű}{{\H{U}}}1 {ő}{{\H{o}}}1 {Ő}{{\H{O}}}1
  {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
  {€}{{\euro}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
  {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1 {¡}{{!`}}1
  {Σ}{{$\Sigma$}}1 {≠}{{$\neq$}}1
}
\definecolor{bgColor}{rgb}{0.97,0.97,0.965}
\lstdefinestyle{C}{
  aboveskip=0.2cm,
  belowskip=0.2cm,
  backgroundcolor=\color{bgColor},
  commentstyle=\color{gray},
  keywordstyle=\color{magenta},
  numberstyle=\tiny\color{gray},
  stringstyle=\color{purple},
  basicstyle=\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  keepspaces=true,
  numbers=left,
  numbersep=5pt,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  tabsize=2,
  language=C
}

\title{Rapport de TP3 d'IT45}
\author{Adrien Burgun}
\date{Printemps 2022}

\begin{document}

\maketitle

\section{Implémentation de l'algorithme de Little}

\subsection{Calcul des distances}

Nous avons en entrée les variables $N_{cities}$, le nombre de villes, et $(x_i, y_i)$, les coordonnées de celles-cis.
Pour pouvoir utiliser l'algorithme de Little, nous calculons la matrices des distances $D$, tel que $D_{ij}$ soit la distance de la ville $i$ jusqu'à la ville $j$.
Nous pouvons utiliser la relation

\[
  \forall i \neq j, \quad D_{ij} = \sqrt{(x_i - x_j)^2 + (y_i - y_j)^2}
\]

La signature dans l'implémentation en C de la matrice $D$ diffère de celle initiallement proposée: je voulais que le code ne soit pas dépendant de la variable \texttt{NBR\_TOWNS}. Il m'est donc impossible d'indiquer au compileur la taille de $D$ sans utiliser des VLA.
Pour accéder à $D_{ij}$, il faut donc écrire \texttt{dist[j * n\_cities + i]} au lieu de \texttt{dist[j][i]}.

\lstinputlisting[style=C, firstline=95, lastline=107]{little.c}

\subsection{Heuristique du voisin le plus proche}

Pour que l'algorithme de Little fonctionne au mieux, il faut lui donner comme information une borne initiale de la distance parcourue.
Plus cette borne est proche de la solution optimale, plus l'algorithme de Little sera efficace à ignorer les branches non-optimales.

Nous construisons cette solution initiale en suivant l'heuristique du voisin le plus proche.
À l'étape $i$, on choisit la prochaine ville de la manière suivante:

\begin{align*}
  u_{i+1} &= \arg \min_{k \in S_i}(D[u_i,u_k]) \\
  S_i &= \llbracket 0; \; N_{cities} \rrbracket \; \backslash \; \{ k \;|\; \exists \; n \le i, u_n = k \}
\end{align*}

\lstinputlisting[style=C, linerange={162-200,211-222}]{little.c}

\subsection{Algorithme de Little}

L'algorithme de Little cherche le cycle Hamiltonien optimal en appliquant la méthode de Branch and Bound avec les informations que l'on peut déduire de la matrice des distances $D$.

À chaque noeud, on vérifie si l'on a construit un chemin entier et on compare dans ce cas ce chemin avec la meilleure solution trouvée auparavant:

\lstinputlisting[style=C, linerange={478-483,485-490,495-495}]{little.c}

Ensuite, on soustrait d'abords à chaque colonne $i$ la valeur de $\min_{j}(D_{ij})$, et on incrémente la valeur minimale du noeud (\texttt{eval}) par cette quantité.
On fait de même pour les lignes $j$; on obtient alors $D'$, une matrice où chaque colonne et chaque ligne est soit infinie, soit contient un ou plusieurs zéros.

\lstinputlisting[style=C, linerange={507-519,521-539,541-545}]{little.c}

On vérifie ensuite si la nouvelle valeur de \texttt{eval} ne dépasse pas la valeur optimale trouvée \texttt{best\_eval}; si c'est le cas, on arrête la recherche du noeud (opération \og Cut \fg):

\lstinputlisting[style=C, linerange={547-548,552-553}]{little.c}

Ensuite, on cherche dans la matrice $D'$ le zéro ayant la plus grande pénalité:

\begin{align*}
  (i^{*}, j^{*}) &= \arg \max_{i,j}(P_{ij} \; | \; D'_{ij} = 0 \; \land \; P_{ij} < \infty) \\
  P_{ij} &= \min_{k \neq i}(D'_{kj}) + \min_{k \neq j}(D'_{ik})
\end{align*}

\lstinputlisting[style=C, linerange={561-584}]{little.c}

Enfin, si $(i^{*}, j^{*})$ existent, on explore la branche $(S \;\cup\; \{i^{*} \rightarrow j^{*}\}, \texttt{eval})$ et la branche $(S \;\cup\; \{\neg(i^{*} \rightarrow j^{*})\}, \texttt{eval} + P_{i^{*}j^{*}})$:

\lstinputlisting[style=C, linerange={587-599,601-602,607-615,619-621,630-633,637-638}]{little.c}

\section{Résultats}

Durant le développement du code, des tests automatisés ont été écrits en parallèle dans le fichier \texttt{test.c}; ceux-cis vérifient le bon fonctionnement du code sur des cas à part et des cas aléatoires.

Pour 6 villes, la solution optimale trouvée est $0, 4, 5, 3, 2, 1$.
Comme la matrice des distances est symmétrique, on peut transformer la solution tel que $S[1] < S[n-1]$.
On obtient alors $0, 1, 2, 3, 5, 4$, avec une distance de $2315.15$.



Pour 10 villes, on obtient $0, 1, 6, 2, 7, 8, 9, 3, 5, 4$ et une distance de $2826.50$.

% \begin{figure}[H]
%   \center
%   \begin{tikzpicture}
%     \node[circle,fill,inner sep=1pt] at (4.81, 4.89) (1) {};
%     \node[circle,fill,inner sep=1pt] at (0.21, 1.57) (2) {};
%     \node[circle,fill,inner sep=1pt] at (2.94, 6.38) (3) {};
%     \node[circle,fill,inner sep=1pt] at (8.04, 5.83) (4) {};
%     \node[circle,fill,inner sep=1pt] at (7.19, 5.57) (5) {};
%     \node[circle,fill,inner sep=1pt] at (7.49, 5.62) (6) {};
%     \node[circle,fill,inner sep=1pt] at (0.21, 1.96) (7) {};
%     \node[circle,fill,inner sep=1pt] at (4.47, 8.51) (8) {};
%     \node[circle,fill,inner sep=1pt] at (4.94, 10.00) (9) {};
%     \node[circle,fill,inner sep=1pt] at (5.53, 9.62) (10) {};

%     \draw (1) -- (2);
%     \draw (2) -- (7);
%     \draw (7) -- (3);
%     \draw (3) -- (8);
%     \draw (8) -- (9);
%     \draw (9) -- (10);
%     \draw (10) -- (4);
%     \draw (4) -- (6);
%     \draw (6) -- (5);
%     \draw[densely dotted] (5) -- (1);
%   \end{tikzpicture}
% \end{figure}

Pour les 52 villes, la solution optimale a une distance de $7544.37$:

\begin{figure}[H]
  \caption{Chemin tracé par la solution optimale de Berlin52}
  \center
  \begin{tikzpicture}
    \node[circle,fill,inner sep=1pt] at (3.25, 3.30) (1) {};
    \node[circle,fill,inner sep=1pt] at (0.14, 1.06) (2) {};
    \node[circle,fill,inner sep=1pt] at (1.98, 4.31) (3) {};
    \node[circle,fill,inner sep=1pt] at (5.43, 3.94) (4) {};
    \node[circle,fill,inner sep=1pt] at (4.86, 3.76) (5) {};
    \node[circle,fill,inner sep=1pt] at (5.06, 3.79) (6) {};
    \node[circle,fill,inner sep=1pt] at (0.14, 1.32) (7) {};
    \node[circle,fill,inner sep=1pt] at (3.02, 5.75) (8) {};
    \node[circle,fill,inner sep=1pt] at (3.33, 6.75) (9) {};
    \node[circle,fill,inner sep=1pt] at (3.74, 6.49) (10) {};
    \node[circle,fill,inner sep=1pt] at (9.22, 3.56) (11) {};
    \node[circle,fill,inner sep=1pt] at (7.01, 3.33) (12) {};
    \node[circle,fill,inner sep=1pt] at (8.42, 1.15) (13) {};
    \node[circle,fill,inner sep=1pt] at (8.79, 0.03) (14) {};
    \node[circle,fill,inner sep=1pt] at (4.86, 3.91) (15) {};
    \node[circle,fill,inner sep=1pt] at (4.17, 2.13) (16) {};
    \node[circle,fill,inner sep=1pt] at (0.83, 3.82) (17) {};
    \node[circle,fill,inner sep=1pt] at (2.39, 3.65) (18) {};
    \node[circle,fill,inner sep=1pt] at (2.93, 5.03) (19) {};
    \node[circle,fill,inner sep=1pt] at (3.22, 2.10) (20) {};
    \node[circle,fill,inner sep=1pt] at (1.72, 2.67) (21) {};
    \node[circle,fill,inner sep=1pt] at (2.99, 3.36) (22) {};
    \node[circle,fill,inner sep=1pt] at (2.76, 2.39) (23) {};
    \node[circle,fill,inner sep=1pt] at (4.80, 3.59) (24) {};
    \node[circle,fill,inner sep=1pt] at (5.60, 3.33) (25) {};
    \node[circle,fill,inner sep=1pt] at (6.98, 1.41) (26) {};
    \node[circle,fill,inner sep=1pt] at (7.59, 1.81) (27) {};
    \node[circle,fill,inner sep=1pt] at (7.18, 2.30) (28) {};
    \node[circle,fill,inner sep=1pt] at (3.79, 1.03) (29) {};
    \node[circle,fill,inner sep=1pt] at (2.36, 1.44) (30) {};
    \node[circle,fill,inner sep=1pt] at (2.41, 3.19) (31) {};
    \node[circle,fill,inner sep=1pt] at (3.30, 3.82) (32) {};
    \node[circle,fill,inner sep=1pt] at (6.61, 6.67) (33) {};
    \node[circle,fill,inner sep=1pt] at (4.02, 3.33) (34) {};
    \node[circle,fill,inner sep=1pt] at (3.94, 3.42) (35) {};
    \node[circle,fill,inner sep=1pt] at (3.94, 3.51) (36) {};
    \node[circle,fill,inner sep=1pt] at (4.43, 3.51) (37) {};
    \node[circle,fill,inner sep=1pt] at (4.57, 3.71) (38) {};
    \node[circle,fill,inner sep=1pt] at (4.14, 3.65) (39) {};
    \node[circle,fill,inner sep=1pt] at (4.37, 3.74) (40) {};
    \node[circle,fill,inner sep=1pt] at (2.73, 5.52) (41) {};
    \node[circle,fill,inner sep=1pt] at (0.55, 1.49) (42) {};
    \node[circle,fill,inner sep=1pt] at (5.03, 5.29) (43) {};
    \node[circle,fill,inner sep=1pt] at (4.02, 2.87) (44) {};
    \node[circle,fill,inner sep=1pt] at (3.19, 4.68) (45) {};
    \node[circle,fill,inner sep=1pt] at (4.77, 2.79) (46) {};
    \node[circle,fill,inner sep=1pt] at (6.72, 0.37) (47) {};
    \node[circle,fill,inner sep=1pt] at (4.77, 3.51) (48) {};
    \node[circle,fill,inner sep=1pt] at (3.48, 3.59) (49) {};
    \node[circle,fill,inner sep=1pt] at (3.42, 2.07) (50) {};
    \node[circle,fill,inner sep=1pt] at (7.70, 4.17) (51) {};
    \node[circle,fill,inner sep=1pt] at (10.00, 1.41) (52) {};

    \draw (1) -- (49);
    \draw (49) -- (32);
    \draw (32) -- (45);
    \draw (45) -- (19);
    \draw (19) -- (41);
    \draw (41) -- (8);
    \draw (8) -- (9);
    \draw (9) -- (10);
    \draw (10) -- (43);
    \draw (43) -- (33);
    \draw (33) -- (51);
    \draw (51) -- (11);
    \draw (11) -- (52);
    \draw (52) -- (14);
    \draw (14) -- (13);
    \draw (13) -- (47);
    \draw (47) -- (26);
    \draw (26) -- (27);
    \draw (27) -- (28);
    \draw (28) -- (12);
    \draw (12) -- (25);
    \draw (25) -- (4);
    \draw (4) -- (6);
    \draw (6) -- (15);
    \draw (15) -- (5);
    \draw (5) -- (24);
    \draw (24) -- (48);
    \draw (48) -- (38);
    \draw (38) -- (37);
    \draw (37) -- (40);
    \draw (40) -- (39);
    \draw (39) -- (36);
    \draw (36) -- (35);
    \draw (35) -- (34);
    \draw (34) -- (44);
    \draw (44) -- (46);
    \draw (46) -- (16);
    \draw (16) -- (29);
    \draw (29) -- (50);
    \draw (50) -- (20);
    \draw (20) -- (23);
    \draw (23) -- (30);
    \draw (30) -- (2);
    \draw (2) -- (7);
    \draw (7) -- (42);
    \draw (42) -- (21);
    \draw (21) -- (17);
    \draw (17) -- (3);
    \draw (3) -- (18);
    \draw (18) -- (31);
    \draw (31) -- (22);
    \draw[densely dotted] (22) -- (1);
  \end{tikzpicture}
\end{figure}

% 00 48 31 44 18 40 07 08 09 42 32 50 10 51 13 12 46 25 26 27 11 24 03 05 14 04 23 47 37 36 39 38 35 34 33 43 45 15 28 49 19 22 29 01 06 41 20 16 02 17 30 21

\subsection{Mesure des performances}

\begin{figure}[H]
  \caption{Temps pris par Little}
  \begin{tikzpicture}
    \begin{axis}[
      ybar,
      bar width=0.4cm,
      width=\columnwidth,
      height=0.5\columnwidth,
      ymax=1000,
      xtick=data,
      ymajorgrids=true,
      xlabel={$N_{cities}$},
      xtick align=inside,
      ylabel={Temps (s, lin)}
    ]
      \addplot+[ybar,fill=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {little.csv};
    \end{axis}
  \end{tikzpicture}

  \begin{tikzpicture}
    \begin{axis}[
      width=\columnwidth,
      height=0.5\columnwidth,
      ymode=log,
      log ticks with fixed point,
      ymin=0.0001,
      ymax=1000,
      ymajorgrids=true,
      xtick=data,
      xlabel={$N_{cities}$},
      ylabel={Temps (s, log)}
    ]
      \addplot+[color=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {little.csv};
    \end{axis}
  \end{tikzpicture}
\end{figure}

% echo '"n", "Time (s)"' | tee glpk.csv; for n in `seq 3 52`; do sed -i -E "s/param n := [0-9]+/param n := ${n}/" tsp.mod; T="$({\time -f "%e" glpsol -m tsp.mod} 2>&1 1>&3 3>&-)" 3>/dev/null; echo "$n, $T" | tee -a glpk.csv; done

\begin{figure}[H]
  \caption{Temps pris par GLPK}
  \begin{tikzpicture}
    \begin{axis}[
      ybar,
      bar width=0.4cm,
      width=\columnwidth,
      height=0.5\columnwidth,
      ymax=1000,
      xtick=data,
      ymajorgrids=true,
      xlabel={$N_{cities}$},
      xtick align=inside,
      ylabel={Temps (s, lin)}
    ]
      \addplot+[ybar,fill=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {glpk.csv};
    \end{axis}
  \end{tikzpicture}

  \begin{tikzpicture}
    \begin{axis}[
      width=\columnwidth,
      height=0.5\columnwidth,
      ymode=log,
      log ticks with fixed point,
      ymin=0.0001,
      ymax=1000,
      ymajorgrids=true,
      xtick=data,
      xlabel={$N_{cities}$},
      ylabel={Temps (s, log)}
    ]
      \addplot+[color=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {glpk.csv};
    \end{axis}
  \end{tikzpicture}
\end{figure}

\begin{figure}[H]
  \caption{Temps pris par Little+}
  \begin{tikzpicture}
    \begin{axis}[
      ybar,
      bar width=0.2cm,
      width=\columnwidth,
      height=0.5\columnwidth,
      ymax=60,
      xmin=0,
      xmax=55,
      % xtick=data,
      ymajorgrids=true,
      xlabel={$N_{cities}$},
      xtick align=inside,
      ylabel={Temps (s, lin)}
    ]
      \addplot+[ybar,fill=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {littleplus.csv};
    \end{axis}
  \end{tikzpicture}

  \begin{tikzpicture}
    \begin{axis}[
      width=\columnwidth,
      height=0.5\columnwidth,
      ymode=log,
      log ticks with fixed point,
      ymin=0.0001,
      ymax=100,
      ymajorgrids=true,
      xmin=0,
      xmax=55,
      % xtick=data,
      xlabel={$N_{cities}$},
      ylabel={Temps (s, log)}
    ]
      \addplot+[color=blue,thick] table[col sep=comma, header=true, x index=0, y index=1] {littleplus.csv};
    \end{axis}
  \end{tikzpicture}
\end{figure}

\end{document}
